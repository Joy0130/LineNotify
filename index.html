<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE 提醒記事本 (GAS)</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="min-h-screen bg-neutral-100 text-slate-800 font-sans">

    <header class="bg-gradient-to-r from-teal-600 to-teal-600 text-white shadow-lg sticky top-0 z-20">
        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="cloud" class="w-6 h-6"></i>
                <h1 class="text-xl font-bold tracking-wide">LINE 記事本 (GAS)</h1>
                <div id="sync-status" class="hidden ml-2 flex items-center gap-1 bg-black/20 px-2 py-1 rounded-full text-xs">
                    <span class="ping-dot h-2 w-2 rounded-full bg-teal-400 mr-1"><span>&#8203;</span></span>
                    <span id="sync-text">已同步</span>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="syncToCloud()" class="p-2 rounded-full hover:bg-white/10 transition-colors" title="上傳到雲端">
                    <i data-lucide="upload-cloud" class="w-6 h-6"></i>
                </button>
                <button onclick="confirmSyncFromCloud()" class="p-2 rounded-full hover:bg-white/10 transition-colors" title="從雲端下載">
                    <i data-lucide="download-cloud" id="sync-icon" class="w-6 h-6"></i>
                </button>
                <button onclick="toggleBackupPanel()" class="p-2 rounded-full hover:bg-white/10 transition-colors" title="備份與還原">
                    <i data-lucide="archive" class="w-6 h-6"></i>
                </button>
                <button onclick="toggleSettings()" class="p-2 rounded-full hover:bg-white/10 transition-colors" title="設定">
                    <i data-lucide="settings" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
    </header>

    <div id="toast-container" class="fixed top-20 right-4 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <main class="max-w-4xl mx-auto px-4 py-6 space-y-6">

        <!-- 雲端設定警告 -->
        <div id="cloud-setup-warning" class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-lg shadow-sm">
            <div class="flex items-start gap-3">
                <i data-lucide="alert-circle" class="w-5 h-5 text-amber-600 mt-0.5"></i>
                <div class="flex-1">
                    <h3 class="font-bold text-amber-900 mb-1">⚙️ 需要完成雲端設定</h3>
                    <p class="text-sm text-amber-800 mb-2">請先在「設定」中配置 GitHub Token 和 Gist ID，才能使用雲端同步功能。</p>
                    <button onclick="toggleSettings()" class="text-xs bg-amber-600 text-white px-3 py-1 rounded hover:bg-amber-700">前往設定</button>
                </div>
                <button onclick="document.getElementById('cloud-setup-warning').remove()" class="text-amber-600 hover:text-amber-800">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <!-- 備份還原面板 -->
        <div id="backup-panel" class="hidden bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500 fade-in">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-lg font-bold text-slate-700 flex items-center gap-2">
                    <i data-lucide="archive" class="w-5 h-5"></i> 資料備份與還原
                </h2>
                <button onclick="toggleBackupPanel()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <p class="text-sm text-slate-500 mb-4">匯出或匯入本地備份檔案。雲端資料會自動儲存在 GitHub Gist。</p>
            <div class="grid md:grid-cols-2 gap-4">
                <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
                    <h3 class="font-bold text-slate-700 mb-2">1. 匯出備份</h3>
                    <button onclick="exportData()" class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i> 下載備份檔
                    </button>
                </div>
                <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
                    <h3 class="font-bold text-slate-700 mb-2">2. 匯入還原</h3>
                    <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(this)">
                    <button onclick="document.getElementById('import-file').click()" class="w-full py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 flex items-center justify-center gap-2">
                        <i data-lucide="upload" class="w-4 h-4"></i> 選擇檔案還原
                    </button>
                </div>
            </div>
        </div>

        <!-- 設定區塊 -->
        <div id="settings-panel" class="hidden bg-white rounded-xl shadow-md p-6 border-l-4 border-teal-500 fade-in">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-lg font-bold text-slate-700 flex items-center gap-2"><i data-lucide="settings" class="w-5 h-5"></i> 設定</h2>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <!-- LINE API 設定 -->
            <div class="mb-6 p-4 bg-teal-50 border border-teal-200 rounded-lg">
                <h3 class="font-bold text-teal-900 mb-3 flex items-center gap-2">
                    <i data-lucide="message-circle" class="w-4 h-4"></i> LINE API 設定
                </h3>
                <div class="grid gap-4 md:grid-cols-2">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-slate-600">LINE User ID</label>
                        <input type="text" id="config-userId" placeholder="Uxxxxxxxx..." class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-slate-600">Channel Access Token</label>
                        <input type="password" id="config-token" placeholder="輸入長串 Token..." class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none">
                    </div>
                </div>
            </div>

            <!-- GitHub 雲端設定 -->
            <div class="mb-6 p-4 bg-blue-90 border border-blue-200 rounded-lg">
                <h3 class="font-bold text-blue-900 mb-2 flex items-center gap-2">
                    <i data-lucide="github" class="w-4 h-4"></i> GitHub 雲端同步設定
                </h3>
                <p class="text-xs text-blue-700 mb-3">設定後資料將儲存在 GitHub Gist，可跨裝置使用</p>
                <div class="space-y-3">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-slate-600">GitHub Personal Access Token</label>
                        <input type="password" id="config-github-token" placeholder="ghp_xxxxxxxxxx..." class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        <p class="text-xs text-slate-500">需要 'gist' 權限。<a href="https://github.com/settings/tokens/new?scopes=gist&description=LINE%20Reminder%20App" target="_blank" class="text-blue-600 underline">點此創建 Token</a></p>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-slate-600">Gist ID（選填，首次留空自動創建）</label>
                        <input type="text" id="config-gist-id" placeholder="留空則自動創建新 Gist" class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
            </div>

            <div class="text-right"><button onclick="saveConfig()" class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 text-sm">儲存設定</button></div>
        </div>

        <!-- 新增記事區塊 -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h2 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2"><i data-lucide="plus" id="form-icon" class="w-5 h-5 text-teal-500"></i><span id="form-title">新增記事</span></h2>
            <form id="note-form" onsubmit="handleFormSubmit(event)" class="space-y-4">
                <input type="hidden" id="edit-id" value="">
                
                <div class="space-y-2">
                    <label class="text-sm font-medium text-slate-600 flex items-center gap-1"><i data-lucide="tag" class="w-4 h-4"></i> 分類</label>
                    <select id="note-category" class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none bg-white">
                        <option value="重要">重要</option>
                        <option value="工作">工作</option>
                        <option value="私事">私事</option>
                        <option value="已完成">已完成</option>
                    </select>
                </div>

                <div id="completion-section" class="hidden space-y-2 bg-slate-50 p-3 rounded-lg border border-slate-100">
                    <label class="text-sm font-bold text-slate-700 flex items-center gap-1"><i data-lucide="check-square" class="w-4 h-4"></i> 執行狀態</label>
                    <select id="note-completion" class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none bg-white">
                        <option value="">預設</option>
                        <option value="completed">完成 (Completed)</option>
                        <option value="incomplete">未完成 (Incomplete)</option>
                    </select>
                </div>

                <div class="space-y-2">
                    <label class="text-sm font-medium text-slate-600">內容</label>
                    <textarea id="note-content" rows="3" placeholder="寫下要做的事情..." required class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none resize-none" oninput="autoResizeTextarea(this)"></textarea>
                </div>
                <div class="grid md:grid-cols-2 gap-4 items-start">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-slate-600 flex items-center gap-1"><i data-lucide="clock" class="w-4 h-4"></i> 發送提醒時間</label>
                        <input type="datetime-local" id="note-datetime" class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-slate-600 flex items-center gap-1"><i data-lucide="refresh-cw" class="w-4 h-4"></i> 重複提醒</label>
                        <div class="flex gap-2">
                            <select id="repeat-select" onchange="handleRepeatChange(this)" class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none bg-white">
                                <option value="none">沒有重複</option>
                                <option value="custom">開啟重複設定...</option>
                            </select>
                            <button type="button" id="edit-repeat-btn" onclick="openRepeatModal()" class="hidden p-2 bg-teal-100 text-teal-700 rounded-lg hover:bg-teal-200 transition-colors"><i data-lucide="edit-3" class="w-5 h-5"></i></button>
                        </div>
                        <div id="repeat-summary" class="text-xs text-teal-600 font-medium hidden leading-relaxed"></div>
                    </div>
                </div>
                <div class="flex items-end justify-end gap-2 pt-2 border-t border-slate-100 mt-4">
                    <button type="button" id="cancel-btn" onclick="resetForm()" class="hidden px-4 py-2 text-slate-500 bg-slate-100 rounded-lg hover:bg-slate-200">取消</button>
                    <button type="submit" class="flex items-center gap-2 px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 shadow-md hover:shadow-lg transition-all"><i data-lucide="save" class="w-4 h-4"></i><span id="submit-btn-text">儲存記事</span></button>
                </div>
            </form>
        </div>

        <!-- 列表區塊 -->
        <div class="space-y-4">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4 px-1">
            <h2 class="text-lg font-bold text-slate-700 flex items-center gap-2">
                <i data-lucide="calendar" class="w-5 h-5"></i> 記事列表 (<span id="note-count">0</span>)
            </h2>
            <div class="flex gap-2 text-xs font-bold overflow-x-auto pb-1 sm:pb-0">
                <button onclick="scrollToCategory('重要')" class="px-3 py-1.5 rounded-full bg-rose-100 text-rose-700 hover:bg-rose-200 transition-colors whitespace-nowrap">重要</button>
                <button onclick="scrollToCategory('工作')" class="px-3 py-1.5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors whitespace-nowrap">工作</button>
                <button onclick="scrollToCategory('私事')" class="px-3 py-1.5 rounded-full bg-teal-100 text-teal-700 hover:bg-teal-200 transition-colors whitespace-nowrap">私事</button>
                <button onclick="scrollToCategory('已完成')" class="px-3 py-1.5 rounded-full bg-purple-100 text-purple-700 hover:bg-purple-200 transition-colors whitespace-nowrap">已完成</button>
            </div>
        </div>

<div id="notes-container" class="space-y-8"></div>
<div id="empty-state" class="hidden text-center py-12 bg-white rounded-xl border-2 border-dashed border-slate-200 text-slate-400"><p>目前沒有任何記事，試著新增一筆吧！</p></div>
    </main>

    <!-- 重複設定彈跳視窗 -->
    <div id="repeat-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md modal-enter overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-teal-600 px-6 py-4 text-white flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="refresh-cw" class="w-5 h-5"></i> 重複規則設定</h3>
                <button onclick="closeRepeatModal(false)" class="hover:bg-white/20 rounded-full p-1 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-5 overflow-y-auto">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-700">開始日期</label>
                    <input type="datetime-local" id="modal-start-date" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-700">重複頻率</label>
                    <select id="modal-frequency" onchange="handleFrequencyChange(this)" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none bg-white">
                        <option value="daily">每天 (Daily)</option>
                        <option value="weekly">每週 (Weekly)</option>
                        <option value="monthly">每月 (Monthly)</option>
                    </select>
                </div>
                <div id="weekly-options" class="hidden p-4 bg-slate-50 rounded-lg border border-slate-200 space-y-3">
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-bold text-slate-700">於 (多選)</label>
                            <button type="button" onclick="clearWeeklySelection()" class="text-xs text-rose-500 hover:text-rose-700 font-medium underline">清空</button>
                        </div>
                        <div class="flex justify-between gap-1">
                            <button type="button" onclick="toggleBtn(this)" data-day="0" class="weekly-btn w-10 h-10 rounded-full border border-slate-300 bg-white text-slate-600 text-sm font-bold hover:bg-slate-100 transition-colors">日</button>
                            <button type="button" onclick="toggleBtn(this)" data-day="1" class="weekly-btn w-10 h-10 rounded-full border border-slate-300 bg-white text-slate-600 text-sm font-bold hover:bg-slate-100 transition-colors">一</button>
                            <button type="button" onclick="toggleBtn(this)" data-day="2" class="weekly-btn w-10 h-10 rounded-full border border-slate-300 bg-white text-slate-600 text-sm font-bold hover:bg-slate-100 transition-colors">二</button>
                            <button type="button" onclick="toggleBtn(this)" data-day="3" class="weekly-btn w-10 h-10 rounded-full border border-slate-300 bg-white text-slate-600 text-sm font-bold hover:bg-slate-100 transition-colors">三</button>
                            <button type="button" onclick="toggleBtn(this)" data-day="4" class="weekly-btn w-10 h-10 rounded-full border border-slate-300 bg-white text-slate-600 text-sm font-bold hover:bg-slate-100 transition-colors">四</button>
                            <button type="button" onclick="toggleBtn(this)" data-day="5" class="weekly-btn w-10 h-10 rounded-full border border-slate-300 bg-white text-slate-600 text-sm font-bold hover:bg-slate-100 transition-colors">五</button>
                            <button type="button" onclick="toggleBtn(this)" data-day="6" class="weekly-btn w-10 h-10 rounded-full border border-slate-300 bg-white text-slate-600 text-sm font-bold hover:bg-slate-100 transition-colors">六</button>
                        </div>
                    </div>
                </div>
                <div id="monthly-options" class="hidden p-4 bg-slate-50 rounded-lg border border-slate-200 space-y-4">
                    <div class="space-y-2">
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-sm font-bold text-slate-700">選擇日期 (可多選)</label>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-slate-400 font-normal">按住 Shift 可選範圍</span>
                                <button type="button" onclick="clearMonthlySelection()" class="text-xs text-rose-500 hover:text-rose-700 font-medium underline">清空</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-7 gap-1" id="month-days-grid"></div>
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-700">結束日期 (最後一天)</label>
                    <input type="datetime-local" id="modal-end-date" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none">
                    <p class="text-xs text-slate-500">若不設定則視為無限期重複</p>
                </div>
            </div>
            <div class="bg-slate-50 px-6 py-4 flex justify-end gap-3 border-t border-slate-100 shrink-0">
                <button onclick="closeRepeatModal(false)" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg transition-colors">取消</button>
                <button onclick="saveRepeatModal()" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 shadow-sm">確認設定</button>
            </div>
        </div>
    </div>

    <!-- 回到頂部按鈕 -->
    <button id="back-to-top" onclick="scrollToTop()" class="bg-teal-500 hover:bg-teal-700 text-white p-3 sm:p-4 rounded-full shadow-lg transition-all" title="回到頂部">
        <i data-lucide="arrow-up" class="w-5 h-5 sm:w-6 sm:h-6"></i>
    </button>

    <footer class="text-center py-8 text-slate-400 text-sm"><p>© 2025 LINE 提醒記事本 (GAS)</p></footer>

    <script src="script.js"></script>
</body>
</html>
